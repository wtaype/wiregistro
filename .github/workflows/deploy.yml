name: 🔥 wiregistro Deploy to Firebase

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy-firebase:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🔎 Debug workspace
        run: |
          echo "📂 Working directory: $(pwd)"
          echo "📄 Files in root:"
          ls -la
          echo ""
          echo "🔥 Checking firebase.json:"
          if [ -f firebase.json ]; then
            echo "✅ firebase.json found"
            cat firebase.json
          else
            echo "❌ firebase.json NOT found"
            exit 1
          fi

      - name: 🎯 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.5'
          channel: 'stable'
          cache: true

      - name: 🔕 Disable Flutter Analytics
        run: flutter config --no-analytics

      - name: 📚 Install dependencies
        run: flutter pub get

      - name: 🏗️ Build for Firebase
        run: flutter build web --release --base-href=/

      - name: 📦 Verify build output
        run: |
          echo "📦 Build output:"
          ls -la build/web/
          echo ""
          echo "📄 index.html exists:"
          test -f build/web/index.html && echo "✅ Yes" || echo "❌ No"

      - name: 🔥 Deploy to Firebase Hosting
        run: |
          npm install -g firebase-tools@latest
          echo "🔥 Firebase CLI version:"
          firebase --version
          echo ""
          echo "🚀 Deploying to Firebase..."
          firebase deploy --non-interactive --only hosting --project "${{ secrets.FIREBASE_PROJECT_ID }}" --token "${{ secrets.FIREBASE_TOKEN }}"

      - name: 🎉 Success
        run: |
          echo ""
          echo "✅ ¡Deploy completado exitosamente!"
          echo "🔥 Tu app está en: https://wiregistro.web.app"
          echo "🔥 También en: https://wiregistro.firebaseapp.com"